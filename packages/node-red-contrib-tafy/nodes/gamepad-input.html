<script type="text/javascript">
    RED.nodes.registerType('tafy-gamepad-input', {
        category: 'tafy',
        color: '#a6bbcf',
        defaults: {
            name: { value: '' },
            deadzone: { value: 0.1, validate: RED.validators.number() },
            pollInterval: { value: 50, validate: RED.validators.number() },
            controllerIndex: { value: 0, validate: RED.validators.number() },
            outputMode: { value: 'differential' }
        },
        inputs: 1,
        outputs: 1,
        icon: 'gamepad.png',
        label: function() {
            return this.name || 'gamepad input';
        },
        paletteLabel: 'gamepad'
    });
</script>

<script type="text/html" data-template-name="tafy-gamepad-input">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
    
    <div class="form-row">
        <label for="node-input-controllerIndex"><i class="fa fa-gamepad"></i> Controller</label>
        <select id="node-input-controllerIndex">
            <option value="0">Controller 1</option>
            <option value="1">Controller 2</option>
            <option value="2">Controller 3</option>
            <option value="3">Controller 4</option>
        </select>
    </div>
    
    <div class="form-row">
        <label for="node-input-outputMode"><i class="fa fa-cog"></i> Output Mode</label>
        <select id="node-input-outputMode">
            <option value="differential">Differential Drive</option>
            <option value="normalized">Normalized</option>
            <option value="raw">Raw Data</option>
        </select>
    </div>
    
    <div class="form-row">
        <label for="node-input-deadzone"><i class="fa fa-circle-o"></i> Deadzone</label>
        <input type="text" id="node-input-deadzone" placeholder="0.1" style="width:70px">
        <span class="form-row-description">Analog stick deadzone (0-1)</span>
    </div>
    
    <div class="form-row">
        <label for="node-input-pollInterval"><i class="fa fa-clock-o"></i> Poll Rate</label>
        <input type="text" id="node-input-pollInterval" placeholder="50" style="width:70px"> ms
        <span class="form-row-description">How often to check gamepad state</span>
    </div>
</script>

<script type="text/html" data-help-name="tafy-gamepad-input">
    <p>Captures gamepad/controller input for robot teleoperation.</p>
    
    <h3>Inputs</h3>
    <dl class="message-properties">
        <dt>payload <span class="property-type">string | boolean</span></dt>
        <dd>Control commands:
            <ul>
                <li><code>"start"</code> or <code>true</code> - Start polling gamepad</li>
                <li><code>"stop"</code> or <code>false</code> - Stop polling gamepad</li>
            </ul>
        </dd>
    </dl>
    
    <h3>Outputs</h3>
    <dl class="message-properties">
        <dt>payload <span class="property-type">object</span></dt>
        <dd>Gamepad state based on output mode</dd>
        <dt>topic <span class="property-type">string</span></dt>
        <dd>Event type: "gamepad/connected", "gamepad/disconnected", or "gamepad/input"</dd>
    </dl>
    
    <h3>Output Modes</h3>
    <h4>Differential Drive</h4>
    <p>Converts gamepad input to differential drive commands:</p>
    <pre>{
    "left": -1.0 to 1.0,   // Left wheel speed
    "right": -1.0 to 1.0,  // Right wheel speed
    "forward": -1.0 to 1.0, // Forward/backward
    "turn": -1.0 to 1.0    // Turn rate
}</pre>
    
    <h4>Normalized</h4>
    <p>Provides normalized axes with deadzone applied and named buttons:</p>
    <pre>{
    "axes": [0.0, -0.5, 0.0, 0.0],  // Deadzone applied
    "buttons": {
        "a": 1.0,
        "lb": 1.0
    }
}</pre>
    
    <h4>Raw Data</h4>
    <p>Provides raw gamepad state as reported by browser:</p>
    <pre>{
    "axes": [-0.003, 0.001, 0.0, 0.0],
    "buttons": [
        {"pressed": false, "value": 0},
        {"pressed": true, "value": 1}
    ],
    "timestamp": 12345.67
}</pre>
    
    <h3>Button Mapping</h3>
    <p>Standard gamepad layout (Xbox/PS style):</p>
    <ul>
        <li>a, b, x, y - Face buttons</li>
        <li>lb, rb - Shoulder buttons</li>
        <li>lt, rt - Triggers</li>
        <li>leftStick, rightStick - Stick clicks</li>
        <li>up, down, left, right - D-pad</li>
        <li>start, back/select - Menu buttons</li>
    </ul>
    
    <h3>Configuration</h3>
    <ul>
        <li><b>Controller:</b> Which gamepad to use (1-4)</li>
        <li><b>Deadzone:</b> Ignore small stick movements (0-1)</li>
        <li><b>Poll Rate:</b> How often to check state in ms</li>
    </ul>
    
    <h3>Browser Support</h3>
    <p>This node requires the Gamepad API and must run in a browser context.
    It works best when deployed to a dashboard page.</p>
    
    <h3>Example Flow</h3>
    <p>Basic teleop control:</p>
    <pre>[Inject "start"] -> [Gamepad] -> [HAL Motor Command] -> [NATS Publish]</pre>
</script>